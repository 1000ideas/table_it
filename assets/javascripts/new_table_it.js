// Generated by CoffeeScript 1.6.3
(function() {
  var TableIt;

  TableIt = (function() {
    function TableIt() {
      this._init_time_add();
      this._init_toast();
      this._init_tooltips();
      this._init_new_issue();
      this._init_close_on_tick();
      this._init_toggle_sidebar();
      true;
    }

    TableIt.prototype.set_api_key = function(key) {
      return this.api_key = key;
    };

    TableIt.prototype.add_time = function(time_input) {
      var time, url;
      time = $(time_input).val();
      url = $(time_input).data('url');
      if (time.length === 0 || (url == null)) {
        return;
      }
      return $.ajax({
        dataType: 'script',
        type: 'POST',
        url: url,
        data: {
          time: time
        },
        complete: function() {
          return $(time_input).val('');
        }
      });
    };

    TableIt.prototype.set_cookie = function(name, value, days) {
      var d;
      if (days == null) {
        days = 1;
      }
      d = new Date();
      d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      return document.cookie = "" + name + "=" + value + "; expires=" + (d.toGMTString());
    };

    TableIt.prototype._init_toggle_sidebar = function() {
      var status,
        _this = this;
      status = document.cookie.match(/sidebar=(open|closed)(?:;|$)/);
      if (status != null) {
        $('#main').toggleClass('nosidebar', status[1] === 'closed');
      }
      return $(document).on('click', '#toggle-sidebar', function(event) {
        var closed;
        event.preventDefault();
        closed = $(event.target).parents('#main').toggleClass('nosidebar').hasClass('nosidebar');
        return _this.set_cookie('sidebar', (closed ? "closed" : "open"), 365);
      });
    };

    TableIt.prototype._init_close_on_tick = function() {
      return $(document).on('click', '.issues td.checkbox input[type=checkbox]', function(event) {
        var checked, closed, url;
        event.preventDefault;
        checked = $(this).is(':checked');
        closed = $(this).parents('tr.closed').length > 0;
        url = $(this).data('url');
        if (checked !== closed) {
          return $.ajax({
            dataType: 'script',
            type: 'POST',
            url: url
          });
        }
      });
    };

    TableIt.prototype._init_new_issue = function() {
      return $(document).on('click', 'h2#new-issue', function(event) {
        event.preventDefault();
        return $(this).next().slideToggle('fast');
      });
    };

    TableIt.prototype._init_time_add = function() {
      var _this = this;
      $(document).on('click', '.add-time-button', function(event) {
        event.preventDefault();
        return _this.add_time($(event.target).prev());
      });
      $(document).on('keyup', '.add-time-input', function(event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          return _this.add_time(event.target);
        }
      });
      return true;
    };

    TableIt.prototype._init_toast = function() {
      this._toast_element();
      $(document).on('click', '#toast', function() {
        var id;
        id = $(this).data('timeout_id');
        if (id != null) {
          clearTimeout(id);
          $(this).removeData('timeout_id');
        }
        return $(this).fadeOut('fast');
      });
      return true;
    };

    TableIt.prototype._toast_element = function() {
      if ($('#toast').length === 0) {
        $(document.body).append($('<div>').attr('id', 'toast').hide().append("<div>"));
      }
      return $('#toast div');
    };

    TableIt.prototype.toast = function(text, class_name) {
      var _this = this;
      if (class_name == null) {
        class_name = 'notice';
      }
      return this._toast_element().each(function(idx, el) {
        var the_toast;
        the_toast = $(el).parent();
        el.className = class_name;
        el.innerHTML = text;
        return the_toast.fadeIn('fast', function() {
          var id,
            _this = this;
          id = setTimeout(function() {
            return the_toast.fadeOut('fast');
          }, 3000);
          return the_toast.data("timeout_id", id);
        });
      });
    };

    TableIt.prototype._init_tooltips = function() {
      return $(document).tooltip({
        items: "[data-tooltip]",
        track: true,
        hide: false,
        content: function() {
          return $(this).data('tooltip');
        }
      });
    };

    return TableIt;

  })();

  jQuery(function() {
    return window.table_it = new TableIt;
  });

}).call(this);
